name: "Hugo - Actions Cache"

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/hugo-boringcache.yml"
      - ".github/workflows/hugo-actions-cache.yml"
      - "dockerfiles/hugo/**"
      - "scripts/**"
  schedule:
    - cron: "0 6 * * 0"

permissions:
  contents: read
  actions: write

env:
  PROJECT_REPO: gohugoio/hugo
  PROJECT_REF: "e6f01bb4649e8708a0b388327ded92a4a454e13e"
  BENCHMARK_ID: hugo
  BENCHMARK_WORKSPACE: boringcache/benchmarks

jobs:
  docker-build:
    name: Docker Build (GHA cache, cold+warm)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PROJECT_REPO }}
          ref: ${{ env.PROJECT_REF }}

      - name: Checkout benchmark config
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: .benchmark-config

      - name: Setup BoringCache CLI
        uses: boringcache/setup-boringcache@v1
        with:
          token: ${{ secrets.BORINGCACHE_API_TOKEN }}
          version: v1.0.3
          platform: linux-amd64
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}

      - name: Prepare deterministic benchmark Dockerfile
        run: |
          cp .benchmark-config/dockerfiles/hugo/Dockerfile.boringcache Dockerfile.boringcache
          cat > ./boringcache-bin <<'SH'
          #!/usr/bin/env sh
          exit 0
          SH
          chmod +x ./boringcache-bin
          echo '!boringcache-bin' >> .dockerignore

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Expose GitHub runtime for Buildx cache
        uses: crazy-max/ghaction-github-runtime@v3

      - name: Set benchmark cache scope
        id: scope
        run: |
          cache_scope="${BENCHMARK_ID}r${GITHUB_RUN_ID}a${GITHUB_RUN_ATTEMPT}"
          scope_started_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "cache_scope=${cache_scope}" >> "$GITHUB_OUTPUT"
          echo "scope_started_at=${scope_started_at}" >> "$GITHUB_OUTPUT"

      - name: Purge benchmark GHA cache keys
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Purge both index manifests and buildkit blobs to avoid
          # "failed to reserve cache" conflicts from previous runs.
          for key_prefix in "index-${BENCHMARK_ID}" "buildkit-blob-"; do
            page=1
            while true; do
              response="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/caches?per_page=100&page=${page}&key=${key_prefix}" 2>/dev/null || true)"
              if [[ -z "$response" ]] || ! jq -e '.actions_caches | type == "array"' <<<"$response" >/dev/null 2>&1; then
                break
              fi

              mapfile -t cache_ids < <(jq -r '.actions_caches[].id' <<<"$response")
              for cache_id in "${cache_ids[@]}"; do
                gh api -X DELETE "/repos/${GITHUB_REPOSITORY}/actions/caches/${cache_id}" >/dev/null 2>&1 || true
              done

              count="$(jq '.actions_caches | length' <<<"$response")"
              if [[ "$count" -lt 100 ]]; then
                break
              fi
              page=$((page + 1))
            done
          done

      - name: Run cold baseline build
        id: cold_baseline_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag hugo-benchmark:latest \
              --progress=plain \
              --no-cache \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_TAG_GOMOD="hugo-gomod" \
              --build-arg BORINGCACHE_TAG_GOBUILD="hugo-gobuild" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Cold build failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Prune builder cache
        run: docker buildx prune -f --builder "${{ steps.buildx.outputs.name }}"

      - name: Seed cache build
        id: seed_cache_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag hugo-benchmark:latest \
              --progress=plain \
              --no-cache \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_TAG_GOMOD="hugo-gomod" \
              --build-arg BORINGCACHE_TAG_GOBUILD="hugo-gobuild" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Seed cache build failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          export_verified=0
          for _ in $(seq 1 20); do
            response="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/caches?per_page=100&key=index-${CACHE_SCOPE}" 2>/dev/null || true)"
            if [[ -n "$response" ]] && jq -e '.actions_caches | type == "array"' <<<"$response" >/dev/null 2>&1; then
              matches="$(jq '.actions_caches | length' <<<"$response")"
              if [[ "$matches" -gt 0 ]]; then
                export_verified=1
                break
              fi
            fi
            sleep 3
          done

          if [[ "$export_verified" -ne 1 ]]; then
            echo "Seed cache export probe failed: no index cache entry was touched for index-${CACHE_SCOPE}" >&2
            exit 1
          fi

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Prune builder cache
        run: docker buildx prune -f --builder "${{ steps.buildx.outputs.name }}"

      - name: Run warm build 1
        id: warm1_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag hugo-benchmark:latest \
              --progress=plain \
              --cache-from "type=gha,scope=${CACHE_SCOPE}" \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_TAG_GOMOD="hugo-gomod" \
              --build-arg BORINGCACHE_TAG_GOBUILD="hugo-gobuild" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Warm build 1 failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run warm build 2
        id: warm2_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag hugo-benchmark:latest \
              --progress=plain \
              --cache-from "type=gha,scope=${CACHE_SCOPE}" \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_TAG_GOMOD="hugo-gomod" \
              --build-arg BORINGCACHE_TAG_GOBUILD="hugo-gobuild" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Warm build 2 failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run stale Docker cache build
        id: stale_docker_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag hugo-benchmark:latest \
              --progress=plain \
              --no-cache \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_TAG_GOMOD="hugo-gomod" \
              --build-arg BORINGCACHE_TAG_GOBUILD="hugo-gobuild" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Stale Docker cache build failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run internal cache warm build (targeted)
        id: internal_only_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag hugo-benchmark:latest \
              --progress=plain \
              --no-cache \
              --target build \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_TAG_GOMOD="hugo-gomod" \
              --build-arg BORINGCACHE_TAG_GOBUILD="hugo-gobuild" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Internal cache warm build failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Measure GHA cache storage usage
        id: cache_size
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bytes="$(.benchmark-config/scripts/sum-gha-cache-by-key.sh "$BENCHMARK_ID" "${{ steps.scope.outputs.scope_started_at }}")"
          echo "bytes=${bytes}" >> "$GITHUB_OUTPUT"

      - name: Write benchmark artifacts
        id: artifact_files
        run: |
          .benchmark-config/scripts/write-benchmark-artifacts.sh \
            --benchmark "$BENCHMARK_ID" \
            --strategy "actions-cache" \
            --project-repo "$PROJECT_REPO" \
            --project-ref "$PROJECT_REF" \
            --cold-seconds "${{ steps.cold_baseline_build.outputs.seconds }}" \
            --warm1-seconds "${{ steps.warm1_build.outputs.seconds }}" \
            --warm2-seconds "${{ steps.warm2_build.outputs.seconds }}" \
            --stale-docker-seconds "${{ steps.stale_docker_build.outputs.seconds }}" \
            --internal-only-warm-seconds "${{ steps.internal_only_build.outputs.seconds }}" \
            --cache-storage-bytes "${{ steps.cache_size.outputs.bytes }}" \
            --cache-storage-source "github-actions-cache-api" \
            --hit-behavior-note "Cold baseline runs --no-cache without remote cache export and with no-op boringcache binary. Seed-cache run reuses buildx builder cache from cold build + cache-to type=gha (mode=max). Warm runs use cache-from/cache-to type=gha (mode=max). Stale Docker run uses --no-cache full build, internal-only run uses --no-cache --target build with boringcache no-op"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ env.BENCHMARK_ID }}-actions-cache
          path: |
            ${{ steps.artifact_files.outputs.json_path }}
            ${{ steps.artifact_files.outputs.md_path }}
          if-no-files-found: error

      - name: Publish summary
        run: cat "${{ steps.artifact_files.outputs.md_path }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Storage comparison with BoringCache
        if: always() && steps.cache_size.outputs.bytes
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          gha_bytes="${{ steps.cache_size.outputs.bytes }}"

          # Query BC API for Hugo entries (skip if no token)
          if [[ -z "${BORINGCACHE_API_TOKEN}" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "_Storage comparison skipped (BORINGCACHE_API_TOKEN not set)_" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          response="$(curl -sf \
            -H "Authorization: Bearer ${BORINGCACHE_API_TOKEN}" \
            -H "User-Agent: BoringCache-CLI/1.0.0" \
            -H "X-BoringCache-Client-Type: CLI" \
            "https://api.boringcache.com/v1/workspaces/${BENCHMARK_WORKSPACE}/caches?limit=100" 2>/dev/null)" || {
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "_Storage comparison skipped (BC API unreachable)_" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          }

          bc_bytes="$(echo "$response" | jq '[.entries[] | select(.tag != null and (.tag | startswith("hugo"))) | .total_size_bytes] | add // 0')"
          bc_count="$(echo "$response" | jq '[.entries[] | select(.tag != null and (.tag | startswith("hugo")))] | length')"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Storage comparison" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Cache | Hugo storage | Notes |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| GitHub Actions | $(numfmt --to=iec-i --suffix=B "${gha_bytes}") | Repo total (buildkit blobs shared across projects) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| BoringCache | $(numfmt --to=iec-i --suffix=B "${bc_bytes}") | ${bc_count} Hugo entries (content-addressed, deduped across branches) |" >> "$GITHUB_STEP_SUMMARY"
