name: "Mastodon Docker - Actions Cache"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 0"

permissions:
  contents: read
  actions: read

env:
  PROJECT_REPO: mastodon/mastodon
  PROJECT_REF: "0b66e744263a4af1f14d03886ea2a9da4ca156db"
  BENCHMARK_ID: mastodon-docker
  BENCHMARK_WORKSPACE: boringcache/benchmarks

jobs:
  docker-build:
    name: Docker Build (GHA cache, cold+warm)
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PROJECT_REPO }}
          ref: ${{ env.PROJECT_REF }}

      - name: Checkout benchmark config
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: .benchmark-config

      - name: Setup BoringCache CLI
        uses: boringcache/setup-boringcache@v1
        with:
          token: ${{ secrets.BORINGCACHE_API_TOKEN }}
          platform: linux-amd64
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}

      - name: Prepare deterministic benchmark Dockerfile
        run: |
          cp .benchmark-config/dockerfiles/mastodon/Dockerfile.boringcache Dockerfile.boringcache
          cat > ./boringcache-bin <<'SH'
          #!/usr/bin/env sh
          exit 0
          SH
          chmod +x ./boringcache-bin
          echo '!boringcache-bin' >> .dockerignore

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Set benchmark cache scope
        id: scope
        run: |
          cache_scope="${BENCHMARK_ID}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "cache_scope=${cache_scope}" >> "$GITHUB_OUTPUT"

      - name: Run cold build
        id: cold_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag mastodon-benchmark:latest \
              --progress=plain \
              --cache-from "type=gha,scope=${CACHE_SCOPE}" \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_CACHE_PREFIX="${CACHE_SCOPE}-" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Cold build failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run warm build 1
        id: warm1_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag mastodon-benchmark:latest \
              --progress=plain \
              --cache-from "type=gha,scope=${CACHE_SCOPE}" \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_CACHE_PREFIX="${CACHE_SCOPE}-" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Warm build 1 failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run warm build 2
        id: warm2_build
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail

          start="$(date +%s)"
          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag mastodon-benchmark:latest \
              --progress=plain \
              --cache-from "type=gha,scope=${CACHE_SCOPE}" \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
              --build-arg BORINGCACHE_CACHE_PREFIX="${CACHE_SCOPE}-" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then
              break
            fi

            if [[ "$attempt" -ge 2 ]]; then
              echo "Warm build 2 failed after retry" >&2
              exit "$status"
            fi

            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Measure GHA cache storage usage
        id: cache_size
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bytes="$(.benchmark-config/scripts/sum-gha-cache-by-key.sh "${{ steps.scope.outputs.cache_scope }}")"
          echo "bytes=${bytes}" >> "$GITHUB_OUTPUT"

      - name: Write benchmark artifacts
        id: artifact_files
        run: |
          .benchmark-config/scripts/write-benchmark-artifacts.sh \
            --benchmark "$BENCHMARK_ID" \
            --strategy "actions-cache" \
            --project-repo "$PROJECT_REPO" \
            --project-ref "$PROJECT_REF" \
            --cold-seconds "${{ steps.cold_build.outputs.seconds }}" \
            --warm1-seconds "${{ steps.warm1_build.outputs.seconds }}" \
            --warm2-seconds "${{ steps.warm2_build.outputs.seconds }}" \
            --cache-storage-bytes "${{ steps.cache_size.outputs.bytes }}" \
            --cache-storage-source "github-actions-cache-api" \
            --hit-behavior-note "GitHub Actions cache type=gha"

      - name: Save benchmark artifacts to BoringCache
        id: save_artifacts
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          base_tag="${BENCHMARK_ID}-artifacts-actions-cache-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          json_tag="${base_tag}-json"
          md_tag="${base_tag}-md"
          boringcache save --no-git "$BENCHMARK_WORKSPACE" "${json_tag}:${{ steps.artifact_files.outputs.json_path }},${md_tag}:${{ steps.artifact_files.outputs.md_path }}"
          echo "json_tag=${json_tag}" >> "$GITHUB_OUTPUT"
          echo "md_tag=${md_tag}" >> "$GITHUB_OUTPUT"

      - name: Verify benchmark artifact restore from BoringCache
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          json_restore_dir="/tmp/benchmark-results-json-restore"
          md_restore_dir="/tmp/benchmark-results-md-restore"
          rm -rf "$json_restore_dir" "$md_restore_dir"
          mkdir -p "$json_restore_dir" "$md_restore_dir"
          boringcache restore --no-git "$BENCHMARK_WORKSPACE" "${{ steps.save_artifacts.outputs.json_tag }}:${json_restore_dir},${{ steps.save_artifacts.outputs.md_tag }}:${md_restore_dir}"
          test -n "$(find "$json_restore_dir" -type f -name '*.json' -print -quit)"
          test -n "$(find "$md_restore_dir" -type f -name '*.md' -print -quit)"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ env.BENCHMARK_ID }}-actions-cache
          path: |
            ${{ steps.artifact_files.outputs.json_path }}
            ${{ steps.artifact_files.outputs.md_path }}
          if-no-files-found: error

      - name: Publish summary
        run: cat "${{ steps.artifact_files.outputs.md_path }}" >> "$GITHUB_STEP_SUMMARY"
