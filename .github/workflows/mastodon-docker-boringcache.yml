name: "Mastodon Docker - BoringCache"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 0"

permissions:
  contents: read
  actions: read

env:
  PROJECT_REPO: mastodon/mastodon
  PROJECT_REF: "0b66e744263a4af1f14d03886ea2a9da4ca156db"
  BENCHMARK_ID: mastodon-docker
  BENCHMARK_WORKSPACE: boringcache/benchmarks

jobs:
  docker-build:
    name: Docker Build (BoringCache, cold+warm)
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PROJECT_REPO }}
          ref: ${{ env.PROJECT_REF }}

      - name: Checkout benchmark config
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: .benchmark-config

      - name: Setup BoringCache CLI
        uses: boringcache/setup-boringcache@v1
        with:
          token: ${{ secrets.BORINGCACHE_API_TOKEN }}
          platform: linux-amd64
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host

      - name: Prepare benchmark build inputs
        id: scope
        run: |
          cp "$(which boringcache)" ./boringcache-bin
          echo '!boringcache-bin' >> .dockerignore
          cp .benchmark-config/dockerfiles/mastodon/Dockerfile.boringcache Dockerfile.boringcache

          cache_scope="${BENCHMARK_ID}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          cache_prefix="${cache_scope}-"
          echo "cache_scope=${cache_scope}" >> "$GITHUB_OUTPUT"
          echo "cache_prefix=${cache_prefix}" >> "$GITHUB_OUTPUT"

      - name: Run cold + warm benchmark builds
        id: build_runs
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
          BUILDER: ${{ steps.buildx.outputs.name }}
          CACHE_SCOPE: ${{ steps.scope.outputs.cache_scope }}
          CACHE_PREFIX: ${{ steps.scope.outputs.cache_prefix }}
        run: |
          set -euo pipefail

          proxy_port=5000
          boringcache docker-registry "$BENCHMARK_WORKSPACE" --host 0.0.0.0 --port "$proxy_port" --no-git --verbose > /tmp/boringcache-proxy.log 2>&1 &
          proxy_pid=$!

          cleanup() {
            if kill -0 "$proxy_pid" >/dev/null 2>&1; then
              kill "$proxy_pid" >/dev/null 2>&1 || true
            fi
          }
          trap cleanup EXIT

          ready=0
          for _ in $(seq 1 60); do
            code="$(curl -s -o /dev/null -w '%{http_code}' "http://127.0.0.1:${proxy_port}/v2/" || true)"
            if [[ "$code" == "200" || "$code" == "401" ]]; then
              ready=1
              break
            fi
            sleep 1
          done

          if [[ "$ready" -ne 1 ]]; then
            echo "Registry proxy did not become ready" >&2
            tail -n 200 /tmp/boringcache-proxy.log || true
            exit 1
          fi

          run_build() {
            local label="$1"
            local start end attempt status

            start="$(date +%s)"
            attempt=1
            while true; do
              set +e
              DOCKER_BUILDKIT=1 docker buildx build \
                --builder "$BUILDER" \
                --file Dockerfile.boringcache \
                --tag mastodon-benchmark:latest \
                --progress=plain \
                --cache-from "type=registry,ref=127.0.0.1:${proxy_port}/${CACHE_SCOPE},registry.insecure=true" \
                --cache-to "type=registry,ref=127.0.0.1:${proxy_port}/${CACHE_SCOPE},mode=max,registry.insecure=true" \
                --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
                --build-arg BORINGCACHE_WORKSPACE="$BENCHMARK_WORKSPACE" \
                --build-arg BORINGCACHE_CACHE_PREFIX="$CACHE_PREFIX" \
                .
              status=$?
              set -e

              if [[ "$status" -eq 0 ]]; then
                break
              fi

              if [[ "$attempt" -ge 2 ]]; then
                echo "Build ${label} failed after retry" >&2
                tail -n 200 /tmp/boringcache-proxy.log || true
                exit "$status"
              fi

              attempt=$((attempt + 1))
              sleep 5
            done

            end="$(date +%s)"
            echo "${label}_seconds=$((end - start))" >> "$GITHUB_OUTPUT"
          }

          run_build cold
          run_build warm1
          run_build warm2

      - name: Measure BoringCache storage usage
        id: cache_size
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          tags_csv="${{ steps.scope.outputs.cache_prefix }}libvips-8.18.0-linux/amd64,${{ steps.scope.outputs.cache_prefix }}ffmpeg-8.0-linux/amd64,${{ steps.scope.outputs.cache_prefix }}mastodon-gems-linux/amd64,${{ steps.scope.outputs.cache_prefix }}mastodon-yarn-linux/amd64,${{ steps.scope.outputs.cache_scope }}"
          bytes="$(.benchmark-config/scripts/sum-boringcache-check-sizes.sh "$BENCHMARK_WORKSPACE" "$tags_csv")"
          echo "bytes=${bytes}" >> "$GITHUB_OUTPUT"

      - name: Write benchmark artifacts
        id: artifact_files
        run: |
          .benchmark-config/scripts/write-benchmark-artifacts.sh \
            --benchmark "$BENCHMARK_ID" \
            --strategy "boringcache" \
            --project-repo "$PROJECT_REPO" \
            --project-ref "$PROJECT_REF" \
            --cold-seconds "${{ steps.build_runs.outputs.cold_seconds }}" \
            --warm1-seconds "${{ steps.build_runs.outputs.warm1_seconds }}" \
            --warm2-seconds "${{ steps.build_runs.outputs.warm2_seconds }}" \
            --cache-storage-bytes "${{ steps.cache_size.outputs.bytes }}" \
            --cache-storage-source "boringcache-check" \
            --bytes-uploaded "${{ steps.cache_size.outputs.bytes }}" \
            --hit-behavior-note "BoringCache registry proxy + CAS dependency tags"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ env.BENCHMARK_ID }}-boringcache
          path: |
            ${{ steps.artifact_files.outputs.json_path }}
            ${{ steps.artifact_files.outputs.md_path }}
          if-no-files-found: error

      - name: Publish summary
        run: cat "${{ steps.artifact_files.outputs.md_path }}" >> "$GITHUB_STEP_SUMMARY"
