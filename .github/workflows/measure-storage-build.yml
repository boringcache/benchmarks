name: "Storage Build"

# Simple Docker build with GHA layer cache. Dispatched by measure-storage.yml
# on different branches to measure cache duplication across branch scopes.
#
# GHA cache entries are scoped by branch ref (JWT token). Running this on
# main, then on PR branches, creates duplicate blobs â€” proving no dedup.

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

env:
  PROJECT_REPO: PostHog/posthog
  PROJECT_REF: "9144e28e3c73b22603e91b23940459eaf15dd147"
  CACHE_SCOPE: posthog-storage-measurement

jobs:
  build:
    name: "PostHog Docker build"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout PostHog
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PROJECT_REPO }}
          ref: ${{ env.PROJECT_REF }}

      - name: Checkout benchmark config
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: main
          path: .benchmark-config

      - name: Prepare Dockerfile and noop boringcache binary
        run: |
          cp .benchmark-config/dockerfiles/posthog/Dockerfile.boringcache Dockerfile.boringcache
          printf '#!/usr/bin/env sh\nexit 0\n' > ./boringcache-bin
          chmod +x ./boringcache-bin
          echo '!boringcache-bin' >> .dockerignore

      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Expose GHA runtime for Buildx cache
        uses: crazy-max/ghaction-github-runtime@v3

      - name: Docker build with GHA layer cache
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
          BORINGCACHE_API_TOKEN: benchmark-noop-token
        run: |
          set -euo pipefail
          start="$(date +%s)"

          attempt=1
          while true; do
            set +e
            DOCKER_BUILDKIT=1 docker buildx build \
              --builder "$BUILDER" \
              --file Dockerfile.boringcache \
              --tag posthog-benchmark:latest \
              --progress=plain \
              --cache-from "type=gha,scope=${CACHE_SCOPE}" \
              --cache-to "type=gha,mode=max,scope=${CACHE_SCOPE}" \
              --secret id=boringcache_token,env=BORINGCACHE_API_TOKEN \
              --build-arg BORINGCACHE_WORKSPACE="boringcache/benchmarks" \
              --build-arg BORINGCACHE_INTERNAL_CACHE_ENABLED="0" \
              .
            status=$?
            set -e

            if [[ "$status" -eq 0 ]]; then break; fi
            if [[ "$attempt" -ge 2 ]]; then exit "$status"; fi
            attempt=$((attempt + 1))
            sleep 5
          done

          end="$(date +%s)"
          echo "Build on \`${{ github.ref_name }}\`: $((end - start))s" >> "$GITHUB_STEP_SUMMARY"
