name: "Zed sccache - BoringCache"

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/zed-sccache-boringcache.yml"
      - ".github/workflows/zed-sccache-actions-cache.yml"
      - "scripts/**"

permissions:
  contents: read
  actions: read

env:
  PROJECT_REPO: zed-industries/zed
  PROJECT_REF: "014bf4c332d58ae9e23166d658d594272588daad"
  BENCHMARK_ID: zed-sccache
  BENCHMARK_WORKSPACE: boringcache/benchmarks

jobs:
  sccache-build:
    name: sccache build (BoringCache, cold+warm)
    runs-on: ubuntu-latest
    timeout-minutes: 240
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PROJECT_REPO }}
          ref: ${{ env.PROJECT_REF }}

      - name: Checkout benchmark config
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: .benchmark-config

      - name: Setup BoringCache CLI
        uses: boringcache/setup-boringcache@v1
        with:
          token: ${{ secrets.BORINGCACHE_API_TOKEN }}
          version: v1.0.3
          platform: debian-bookworm-amd64
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxkbcommon-dev libwayland-dev libvulkan-dev \
            libasound2-dev libfontconfig1-dev libfreetype6-dev \
            libssl-dev pkg-config cmake \
            libx11-dev libx11-xcb-dev libxcb1-dev \
            libxcursor-dev libxinerama-dev libxi-dev libxrandr-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        run: |
          set -euo pipefail
          SCCACHE_VERSION="0.13.0"
          ARCHIVE="sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz"
          URL="https://github.com/mozilla/sccache/releases/download/v${SCCACHE_VERSION}/${ARCHIVE}"
          TMP_DIR="$(mktemp -d)"
          trap 'rm -rf "$TMP_DIR"' EXIT
          curl -sS --fail --location --output "${TMP_DIR}/${ARCHIVE}" "$URL"
          tar -xzf "${TMP_DIR}/${ARCHIVE}" -C "$TMP_DIR"
          sudo install -m 0755 "${TMP_DIR}/sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl/sccache" /usr/local/bin/sccache
          sccache --version

      - name: Prepare benchmark scope and helpers
        id: scope
        run: |
          set -euo pipefail

          cache_scope="${BENCHMARK_ID}r${GITHUB_RUN_ID}a${GITHUB_RUN_ATTEMPT}"
          scope_started_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          tag_cargo_registry="zed-cargo-registry"
          tag_cargo_git="zed-cargo-git"
          tag_target="zed-target"
          tag_sccache="zed-sccache"
          tags_csv="${tag_cargo_registry},${tag_cargo_git},${tag_target},${tag_sccache}"

          echo "cache_scope=${cache_scope}" >> "$GITHUB_OUTPUT"
          echo "scope_started_at=${scope_started_at}" >> "$GITHUB_OUTPUT"
          echo "tag_cargo_registry=${tag_cargo_registry}" >> "$GITHUB_OUTPUT"
          echo "tag_cargo_git=${tag_cargo_git}" >> "$GITHUB_OUTPUT"
          echo "tag_target=${tag_target}" >> "$GITHUB_OUTPUT"
          echo "tag_sccache=${tag_sccache}" >> "$GITHUB_OUTPUT"
          echo "tags_csv=${tags_csv}" >> "$GITHUB_OUTPUT"

          cat > ./run-zed-sccache-phase.sh <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail

          mode="${1:-warm}"

          run_cold_build() {
            cargo build --release
          }

          run_cached_build() {
            export SCCACHE_DIR="${HOME}/.cache/sccache"
            export SCCACHE_CACHE_SIZE="10G"
            export SCCACHE_IDLE_TIMEOUT="0"
            export RUSTC_WRAPPER="sccache"
            export CC="sccache cc"
            export CXX="sccache c++"

            sccache --start-server || true
            cargo build --release
            sccache --show-stats || true
          }

          apply_stale_change() {
            local stale_file
            stale_file="$(git ls-files '*.rs' | head -n1)"
            if [[ -z "${stale_file}" ]]; then
              echo "No Rust source file found for stale mutation" >&2
              exit 1
            fi

            echo "// benchmark stale mutation ${GITHUB_RUN_ID:-local}-$(date +%s)" >> "${stale_file}"
            echo "Applied stale change to ${stale_file}"
          }

          case "$mode" in
            cold)
              run_cold_build
              ;;
            warm)
              run_cached_build
              ;;
            stale)
              apply_stale_change
              run_cached_build
              ;;
            *)
              echo "Unknown mode: $mode" >&2
              exit 1
              ;;
          esac
          SH
          chmod +x ./run-zed-sccache-phase.sh

      - name: Purge BoringCache benchmark tags
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          set -euo pipefail
          boringcache delete --no-git "$BENCHMARK_WORKSPACE" "${{ steps.scope.outputs.tags_csv }}" || true

      - name: Run cold baseline build
        id: cold_baseline_build
        run: |
          set -euo pipefail
          rm -rf target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"
          mkdir -p target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"

          start="$(date +%s)"
          ./run-zed-sccache-phase.sh cold
          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Seed cache build
        id: seed_cache_build
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"
          mkdir -p target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"

          start="$(date +%s)"
          ./run-zed-sccache-phase.sh warm
          boringcache save --no-git "$BENCHMARK_WORKSPACE" \
            "${{ steps.scope.outputs.tag_cargo_registry }}:${HOME}/.cargo/registry,${{ steps.scope.outputs.tag_cargo_git }}:${HOME}/.cargo/git,${{ steps.scope.outputs.tag_target }}:target,${{ steps.scope.outputs.tag_sccache }}:${HOME}/.cache/sccache"
          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run warm build 1
        id: warm1_build
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"
          mkdir -p target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"

          start="$(date +%s)"
          boringcache restore --no-git "$BENCHMARK_WORKSPACE" \
            "${{ steps.scope.outputs.tag_cargo_registry }}:${HOME}/.cargo/registry,${{ steps.scope.outputs.tag_cargo_git }}:${HOME}/.cargo/git,${{ steps.scope.outputs.tag_target }}:target,${{ steps.scope.outputs.tag_sccache }}:${HOME}/.cache/sccache"
          ./run-zed-sccache-phase.sh warm
          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run warm build 2
        id: warm2_build
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"
          mkdir -p target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"

          start="$(date +%s)"
          boringcache restore --no-git "$BENCHMARK_WORKSPACE" \
            "${{ steps.scope.outputs.tag_cargo_registry }}:${HOME}/.cargo/registry,${{ steps.scope.outputs.tag_cargo_git }}:${HOME}/.cargo/git,${{ steps.scope.outputs.tag_target }}:target,${{ steps.scope.outputs.tag_sccache }}:${HOME}/.cache/sccache"
          ./run-zed-sccache-phase.sh warm
          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Run stale build
        id: stale_docker_build
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"
          mkdir -p target "$HOME/.cargo/registry" "$HOME/.cargo/git" "$HOME/.cache/sccache"

          start="$(date +%s)"
          boringcache restore --no-git "$BENCHMARK_WORKSPACE" \
            "${{ steps.scope.outputs.tag_cargo_registry }}:${HOME}/.cargo/registry,${{ steps.scope.outputs.tag_cargo_git }}:${HOME}/.cargo/git,${{ steps.scope.outputs.tag_target }}:target,${{ steps.scope.outputs.tag_sccache }}:${HOME}/.cache/sccache"
          ./run-zed-sccache-phase.sh stale
          end="$(date +%s)"
          echo "seconds=$((end - start))" >> "$GITHUB_OUTPUT"

      - name: Measure BoringCache storage usage
        id: cache_size
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        run: |
          tags_csv="${{ steps.scope.outputs.tags_csv }}"
          bytes="$(.benchmark-config/scripts/sum-boringcache-check-sizes.sh "$BENCHMARK_WORKSPACE" "$tags_csv")"
          echo "bytes=${bytes}" >> "$GITHUB_OUTPUT"

      - name: Write benchmark artifacts
        id: artifact_files
        run: |
          .benchmark-config/scripts/write-benchmark-artifacts.sh \
            --benchmark "$BENCHMARK_ID" \
            --strategy "boringcache" \
            --project-repo "$PROJECT_REPO" \
            --project-ref "$PROJECT_REF" \
            --cold-seconds "${{ steps.cold_baseline_build.outputs.seconds }}" \
            --warm1-seconds "${{ steps.warm1_build.outputs.seconds }}" \
            --warm2-seconds "${{ steps.warm2_build.outputs.seconds }}" \
            --stale-docker-seconds "${{ steps.stale_docker_build.outputs.seconds }}" \
            --cache-storage-bytes "${{ steps.cache_size.outputs.bytes }}" \
            --cache-storage-source "boringcache-check" \
            --hit-behavior-note "Cold baseline runs without restore and without sccache wrapper. Seed run rebuilds from empty state with sccache enabled, then saves cargo registry/git, target, and sccache directories to BoringCache. Warm1/Warm2 restore those caches before build. Stale run restores warm cache, mutates one Rust source file, then rebuilds."

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ env.BENCHMARK_ID }}-boringcache
          path: |
            ${{ steps.artifact_files.outputs.json_path }}
            ${{ steps.artifact_files.outputs.md_path }}
          if-no-files-found: error

      - name: Publish summary
        run: cat "${{ steps.artifact_files.outputs.md_path }}" >> "$GITHUB_STEP_SUMMARY"
